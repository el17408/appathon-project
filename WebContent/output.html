<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        
        <title>Appathon project</title>
        
		<!-- Load stylesheet -->
		<link rel="stylesheet" type="text/css" href="styles.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		
		<!-- Load favicon -->
		<link rel="icon" type="image/x-icon" href="favicon.ico">
		
		
        <!-- Load js files to use with google maps -->
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDR919QvVF2Y632fs9uwdASsOAiVaykJd4" type="text/javascript"></script>
		
		
    </head>
    
     <body>
    <!-- Gif while loading data , doesn't work properly -->
    <div class="loader-wrapper">
    	<span class="loader"><span class="loader-inner"></span></span>
    </div>
    
	<!-- The form -->
    <div>
		<form class="example" onsubmit="">
		<a href="http://localhost:8080/appathon_project/"><img src="logo.jpg" title="NTUA" ></a>
		
		  <input type="text" placeholder="Search for a disease..." id="search" name="search">
		  
		  <button type="submit"><i class="fa fa-search"></i></button>
		  <br>
		  
		<!-- The radio buttons -->
		  <input type="radio" id="format" name="format" value="map" checked>
		  	<label for="map">Map</label>
		  <input type="radio" id="format" name="format" value="json">
		  	<label for="json">json</label>
		</form>
		
		<!-- The google maps div -->
        <div id="map_canvas" style="width: 1326px; height:567px;"></div>
    </div>
    <footer class="footer-container text-center">
    	<div class="container">
    		<p> Â© Website created by Dimitris Roussis 
    			<a href="https://github.com/el17408/appathon-project" title="" class="fa-icon">
    				<i class="fa fa-github"></i>
    			</a></p>
    	</div>
    
    </footer>
    
	<!-- Script to remove loader after page is loaded -->
    <script>
    	$(window).on("load",function(){
    		$(".loader-wrapper").fadeOut("slow");
    	});
    	
    </script>
    
    </body>
    <script type="text/javascript">
		// check DOM Ready
		$(document).ready(function() {
		    // execute
		    (function() {
		    		
			    	var input = getUrlVars()["search"];
			    	if (input === "" || input === " ") {
			    		return;
			    	}
					input = input.split("+");	//remove all occurances of +
					input = input.join(' ');	// and replace them with a space
			    	 if (getUrlVars()["format"] == "map"){
			    		createOutput(JSON.parse(httpGet("http://localhost:8080/appathon_project/sql_request.php?input="+input)),"map");
		    		}
		    		else if(getUrlVars()["format"] == "json") {
		    			createOutput(JSON.parse(httpGet("http://localhost:8080/appathon_project/sql_request.php?input="+input)),"json");
		    		}
		    		return;
		    })();
		});
		    	
				function getUrlVars() {
		    	        var vars = {};
		    	        var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
		    	            vars[key] = value;
		    	        });
		    	        return vars;
		    	}
		    	function createOutput( output , format ) {
		    		var toReturn = [];
		    		
		    		for(var i = 0; i < output.length; i++) {
		    			var request = JSON.parse(httpGet("https://maps.googleapis.com/maps/api/geocode/json?key=AIzaSyDR919QvVF2Y632fs9uwdASsOAiVaykJd4&address="+output[i].country_name));
						if (request.status == "ZERO_RESULTS") {
							continue;
						}
						else{
						
			    			output[i]["lat"] = request.results[0].geometry.location.lat;
			    			
			    			output[i]["lng"] = request.results[0].geometry.location.lng;
			    			toReturn.push(output[i]);
						}
		    		}
		    		if (format == "map"){
		    			return makeMarkers(toReturn);
		    		}
		    		else {
		    			if(toReturn.length == 0){
			    			document.body.innerHTML= "{status : Zero_Results}";
			    			return;
		    			}
		    			toReturn.push({status:200});
		    			document.body.innerHTML= JSON.stringify(toReturn);
		    			return;
		    		}
		    	}

		    	function httpGet(theUrl)
		    	{
		    		if (window.XMLHttpRequest){
		    		 	var xmlHttp = new XMLHttpRequest();
		    		 }
		    		 else {
		    			 var xmlHttp = new ActiveObject("Microsoft.XMLHTTP");
		    		 }
		    	    xmlHttp.open( "GET", theUrl, false ); // false for synchronous request
		    	    xmlHttp.send( null );
		    	    return xmlHttp.responseText;
		    	}
		    	
		    	
		    	function makeMarkers(arr){
		    		var options = {
		    	                    zoom: 2,
		    	                    center: new google.maps.LatLng(45.8665231, -6.9240942), 
		    	                    mapTypeId: google.maps.MapTypeId.TERRAIN,
		    	                    mapTypeControl: false
		    	                };

		    	    // init map
		    		var map = new google.maps.Map(document.getElementById('map_canvas'), options);
		    		for (var i = 0; i < arr.length; i++) {
		    			// init markers
		    			var marker = new google.maps.Marker({
		    				position: new google.maps.LatLng(arr[i].lat, arr[i].lng),
		    				map : map,
		    				title: arr[i].country_name,
		    				label : arr[i].cnt
		    			});
		    		}
		    	}
		   
		</script>
</html>