<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<link rel="stylesheet" type="text/css" href="styles.css">
		<!-- Load icon library -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <title>Appathon project</title>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDR919QvVF2Y632fs9uwdASsOAiVaykJd4" type="text/javascript"></script>
		<script src="make_markers.js" type="text/javascript"></script>
		
    </head>
    <body>
    
    <div class="loader-wrapper">
    	<span class="loader"><span class="loader-inner"></span></span>
    </div>
    
    <div>
		<!-- The form -->
		<form class="example" onsubmit="validateFormOnSubmit();">
		<a href="http://localhost:8080/appathon_project/"><img src="logo.jpg" title="NTUA" ></a>
		
		  <input type="text" placeholder="Search for a disease..." id="search" name="search">
		  
		  <button type="submit"><i class="fa fa-search"></i></button>
		  <br>
		  <input type="radio" id="format" name="format" value="map" checked>
		  	<label for="map">Map</label>
		  <input type="radio" id="format" name="format" value="json">
		  	<label for="json">json</label>
		</form>
        <div id="map_canvas" style="width: 1326px; height:567px;"></div>
    </div>
    <footer class="footer-container text-center">
    	<div class="container">
    		<p> Â© Website created by Dimitris Roussis 
    			<a href="https://github.com/el17408/appathon-project" title="" class="fa-icon">
    				<i class="fa fa-github"></i>
    			</a></p>
    	</div>
    
    </footer>
    <script>
    	$(window).on("load",function(){
    		$(".loader-wrapper").fadeOut("slow");
    	});
    	
    </script>
    
    </body>
    <script type="text/javascript">
		// check DOM Ready
		$(document).ready(function() {
		    // execute
		    (function() {
		    		//<% String name = request.getParameter( "input" ); %>
			    	var input = getUrlVars()["search"];
					input = input.split("+");	//remove all occurances of +
					input = input.join(' ');	// ^^
			    	
		    		if (getUrlVars()["format"] == "map"){
			    		createOutput(JSON.parse(httpGet("http://localhost:8080/appathon_project/sql_request.php?input="+input)),"map");
		    		}
		    		else {
		    			createOutput(JSON.parse(httpGet("http://localhost:8080/appathon_project/sql_request.php?input="+input)),"json");
		    		}/*
		    	    xmlHttp.open( "POST", "sql_request.php", true ); // true for asynchronous request
		    	    xmlHttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		    	    xmlHttp.send('input='+input);  
		    	    var results = JSON.parse(this.responseText);
		    		return createOutput(results);
		    	    xmlHttp.onreadystatechange = function(){ 
		    	    	if (this.readystate === 4 && this.status === 200) {
		    	    		console.log(this.responseText); 
		    	    		var results = JSON.parse(this.responseText);
		    	        	return createOutput(results);
		    	    	}
		    	    }; 
		    	    */

		    	
		    	function getUrlVars() {
		    	        var vars = {};
		    	        var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
		    	            vars[key] = value;
		    	        });
		    	        return vars;
		    	}
		    	function createOutput( output , format ) {
		    		var toReturn = [];
		    		//console.log(output);
		    		
		    		for(var i = 0; i < output.length; i++) {
		    			var request = JSON.parse(httpGet("https://maps.googleapis.com/maps/api/geocode/json?key=AIzaSyDR919QvVF2Y632fs9uwdASsOAiVaykJd4&address="+output[i].country_name));
						if (request.status == "ZERO_RESULTS") {
							continue;
						}
						else{
						
			    			output[i]["lat"] = request.results[0].geometry.location.lat;
			    			
			    			output[i]["lng"] = request.results[0].geometry.location.lng;
			    			toReturn.push(output[i]);
						}
		    		}
		    		if (format == "map"){
		    			return makeMarkers(toReturn);
		    		}
		    		else {
		    			if(toReturn.length == 0){
			    			document.body.innerHTML= "{status : Zero_Results}";
			    			return;
		    			}
		    			toReturn.push({status:200});
		    			document.body.innerHTML= JSON.stringify(toReturn);
		    			return;
		    		}
		    	}

		    	function httpGet(theUrl)
		    	{
		    	    var xmlHttp = new XMLHttpRequest();
		    	    xmlHttp.open( "GET", theUrl, false ); // false for synchronous request
		    	    xmlHttp.send( null );
		    	    return xmlHttp.responseText;
		    	}
		    	////$result = $conn->query( "SELECT country_name , count(country_name) as cnt from trials,country where official_title LIKE '%"+$input+"%' or brief_title LIKE '%"+$input+"%' or acronym LIKE '%"+$input+"%' group by country_name") or die($conn->connect_error);

		    	function makeMarkers(arr){
		    		var options = {
		    	                    zoom: 2,
		    	                    center: new google.maps.LatLng(45.8665231, -6.9240942), 
		    	                    mapTypeId: google.maps.MapTypeId.TERRAIN,
		    	                    mapTypeControl: false
		    	                };

		    	    // init map
		    		var map = new google.maps.Map(document.getElementById('map_canvas'), options);
		    		for (var i = 0; i < arr.length; i++) {
		    			// init markers
		    			var marker = new google.maps.Marker({
		    				position: new google.maps.LatLng(arr[i].lat, arr[i].lng),
		    				map : map,
		    				title: arr[i].country_name,
		    				label : arr[i].cnt
		    			});
		    		}
		    	}
		    })();
		});
		</script>
</html>